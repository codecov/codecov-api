name: API CI

on:
  push:
    branches:
      - master
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true


jobs:
  lint:
    name: Run Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          make lint.install
      - name: Check
        run: |
          make lint.check
  build:
    name: Build API
    runs-on: ubuntu-latest
    env:
      AR_REPO: ${{ secrets.CODECOV_API_IMAGE_V2 }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: "auth"
        if: github.repository_owner == 'codecov'
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v1.1.1"
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.CODECOV_GCP_WIDP }}
          service_account: ${{ secrets.CODECOV_GCP_WIDSA }}

      - name: Docker configuration
        if: github.repository_owner == 'codecov'
        run: |-
          echo ${{steps.auth.outputs.access_token}} | docker login -u oauth2accesstoken --password-stdin https://us-docker.pkg.dev

      - name: Build/pull requirements
        run: |
          make build.requirements
      - name: Push Requirements
        if: github.repository_owner == 'codecov'
        run: |
          make push.requirements
      - name: Build app
        run: |
          make build.app
          make save.app
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-image
          path: app.tar
  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    env:
      AR_REPO: ${{ secrets.CODECOV_API_IMAGE_V2 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: app-image
          path: /tmp
      - name: Load built image
        run: |
          docker load --input /tmp/app.tar
          docker image ls -a
      - name: Install docker compose
        run: |
          sudo curl -SL https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
      - name: Bring test env up
        run: |
          make test_env.up
      - name: Prepare for tests
        run: |
          make test_env.prepare
      - name: Run unit tests
        run: |
          make test_env.run_unit
      - name: Check for migration conflicts
        run: |
          make test_env.check-for-migration-conflicts
